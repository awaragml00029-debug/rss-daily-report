name: Update Latest HTML

# æ·»åŠ æƒé™å£°æ˜
permissions:
  contents: write  # å…è®¸æ¨é€ä»£ç 

on:
  # æ¯å¤© 05:45 åŒ—äº¬æ—¶é—´ = 21:45 UTCï¼ˆæ¯”ä¸» workflow å»¶è¿Ÿ 15 åˆ†é’Ÿï¼‰
  # å¦‚æœä½ æƒ³æ”¹ä¸º 23:15 åŒ—äº¬æ—¶é—´è¿è¡Œï¼Œè¯·ä½¿ç”¨: '30 15 * * *'
  schedule:
    - cron: '45 21 * * *'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      date:
        description: 'æŒ‡å®šæ—¥æœŸ (YYYY-MM-DD)'
        required: false

jobs:
  update-latest-html:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate Latest HTML
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_API_URL: ${{ secrets.GEMINI_API_URL }}
        run: |
          echo "ğŸŒ ç”Ÿæˆ latest.html..."

          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p temp_latest_html

          # ç”ŸæˆæŠ¥å‘Šï¼ˆåªéœ€è¦ HTMLï¼‰
          if [ -n "${{ github.event.inputs.date }}" ]; then
            python scripts/generate_report.py --mode daily --date "${{ github.event.inputs.date }}"
          else
            python scripts/generate_report.py --mode daily
          fi

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
          if [ -f "temp_hugo/latest.html" ]; then
            cp temp_hugo/latest.html temp_latest_html/
            echo "âœ… latest.html å·²ç”Ÿæˆ"
          else
            echo "âŒ latest.html ç”Ÿæˆå¤±è´¥"
            exit 1
          fi

      - name: Push to Static Website Repository (Sparse Checkout)
        env:
          B_ACCOUNT_TOKEN: ${{ secrets.B_ACCOUNT_TOKEN }}
        run: |
          echo "ğŸš€ æ¨é€ latest.html åˆ°é™æ€ç½‘ç«™ä»“åº“..."

          # ä» config.yaml è¯»å–é…ç½®
          STATIC_REPO="${STATIC_REPO:-ixxmu/FigureYa_blog}"
          STATIC_BRANCH="${STATIC_BRANCH:-main}"

          # é…ç½® Git
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

          # åˆ›å»ºä¸´æ—¶ç›®å½•
          STATIC_CLONE_DIR="temp_static_repo"
          rm -rf "$STATIC_CLONE_DIR"
          mkdir -p "$STATIC_CLONE_DIR"
          cd "$STATIC_CLONE_DIR"

          echo "ğŸ“¦ ä½¿ç”¨ç¨€ç–æ£€å‡ºå…‹éš†é™æ€ç½‘ç«™ä»“åº“ï¼ˆåªä¸‹è½½ latest.htmlï¼‰..."

          # åˆå§‹åŒ– Git ä»“åº“
          git init
          git remote add origin "https://${B_ACCOUNT_TOKEN}@github.com/${STATIC_REPO}.git"

          # å¯ç”¨ç¨€ç–æ£€å‡º
          git config core.sparseCheckout true

          # æŒ‡å®šåªæ£€å‡º latest.html
          echo "latest.html" >> .git/info/sparse-checkout

          # æ‹‰å–æŒ‡å®šåˆ†æ”¯ï¼ˆæµ…å…‹éš†ï¼Œåªæ‹‰å–æœ€æ–°æäº¤ï¼‰
          git pull --depth=1 origin "$STATIC_BRANCH"

          # åˆ‡æ¢åˆ°æ­£ç¡®çš„åˆ†æ”¯
          git checkout "$STATIC_BRANCH" 2>/dev/null || git checkout -b "$STATIC_BRANCH"

          echo "âœ… ç¨€ç–æ£€å‡ºå®Œæˆ"

          # å¤åˆ¶æ–°çš„ latest.html
          cp ../temp_latest_html/latest.html .
          echo "âœ… latest.html å·²æ›´æ–°"

          # æäº¤å¹¶æ¨é€
          git add latest.html

          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æ¨é€"
          else
            DATE=$(date +%Y-%m-%d)
            git commit -m "ğŸŒ Update latest daily report $DATE"

            # æ¨é€ï¼Œå¸¦é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š 4 æ¬¡ï¼ŒæŒ‡æ•°é€€é¿ï¼‰
            MAX_RETRIES=4
            RETRY_COUNT=0
            RETRY_DELAY=2

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "å°è¯•æ¨é€ (ç¬¬ $((RETRY_COUNT + 1)) æ¬¡)..."

              if git push -u origin "$STATIC_BRANCH"; then
                echo "âœ… å·²æ¨é€åˆ°é™æ€ç½‘ç«™ä»“åº“"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))

                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "âš ï¸  æ¨é€å¤±è´¥ï¼Œç­‰å¾… ${RETRY_DELAY}s åé‡è¯•..."
                  sleep $RETRY_DELAY
                  RETRY_DELAY=$((RETRY_DELAY * 2))  # æŒ‡æ•°é€€é¿ï¼š2s, 4s, 8s, 16s
                else
                  echo "âŒ æ¨é€å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°"
                  exit 1
                fi
              fi
            done
          fi

          cd ..
          rm -rf "$STATIC_CLONE_DIR"

          echo "âœ¨ latest.html æ›´æ–°å®Œæˆï¼"

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -rf temp_hugo temp_latest_html
