name: Generate Imaging Report (Example)

# è¿™æ˜¯åŒ»å­¦å½±åƒæŠ¥å‘Šçš„ç¤ºä¾‹ workflow
# è¦å¯ç”¨æ­¤æŠ¥å‘Šï¼š
# 1. åœ¨ config.yaml ä¸­å°† report_configs.imaging.enabled è®¾ç½®ä¸º true
# 2. åœ¨ GitHub Secrets ä¸­æ·»åŠ  SHEET_ID_2
# 3. å°†æ­¤æ–‡ä»¶é‡å‘½åä¸º generate-report-imaging.yml

# æ·»åŠ æƒé™å£°æ˜
permissions:
  contents: write  # å…è®¸æ¨é€ä»£ç 

on:
  # æ¯å¤© 06:00 (åŒ—äº¬æ—¶é—´) = 22:00 UTC è¿è¡Œï¼ˆä¸ç”Ÿç‰©ä¿¡æ¯å­¦æŠ¥å‘Šé”™å¼€ï¼‰
  schedule:
    - cron: '0 22 * * *'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      mode:
        description: 'ç”Ÿæˆæ¨¡å¼ (daily/monthly)'
        required: true
        default: 'daily'
        type: choice
        options:
          - daily
          - monthly
      date:
        description: 'æŒ‡å®šæ—¥æœŸ (YYYY-MM-DDï¼Œä»…ç”¨äº daily æ¨¡å¼)'
        required: false
      year:
        description: 'æŒ‡å®šå¹´ä»½ï¼ˆä»…ç”¨äº monthly æ¨¡å¼ï¼‰'
        required: false
      month:
        description: 'æŒ‡å®šæœˆä»½ï¼ˆä»…ç”¨äº monthly æ¨¡å¼ï¼‰'
        required: false

jobs:
  generate-daily-report:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'daily')

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate Daily Report (Imaging)
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          SHEET_ID_2: ${{ secrets.SHEET_ID_2 }}  # åŒ»å­¦å½±åƒæŠ¥å‘Šçš„ Sheet ID
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_API_URL: ${{ secrets.GEMINI_API_URL }}
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            python scripts/generate_report.py --config-name imaging --mode daily --date "${{ github.event.inputs.date }}"
          else
            python scripts/generate_report.py --config-name imaging --mode daily
          fi

      - name: Commit and Push to Current Repo
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add reports/
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "ğŸ“Š Imaging report $(date +%Y-%m-%d)"
            git push
            echo "æŠ¥å‘Šå·²æäº¤å¹¶æ¨é€"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push to Hugo and Backup Repos
        env:
          B_ACCOUNT_TOKEN: ${{ secrets.B_ACCOUNT_TOKEN }}
        run: |
          chmod +x scripts/push_to_repos.sh
          bash scripts/push_to_repos.sh

  generate-monthly-report:
    runs-on: ubuntu-latest
    # æ¯æœˆ28-31å·è¿è¡Œï¼Œæˆ–æ‰‹åŠ¨è§¦å‘ monthly æ¨¡å¼
    if: |
      (github.event_name == 'schedule' &&
       (github.event.schedule == '0 15 28 * *' ||
        github.event.schedule == '0 15 29 * *' ||
        github.event.schedule == '0 15 30 * *' ||
        github.event.schedule == '0 15 31 * *')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'monthly')

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check if Last Day of Month
        id: check_date
        run: |
          # è·å–å½“å‰æ—¥æœŸ
          current_day=$(date +%d)
          current_month=$(date +%m)
          current_year=$(date +%Y)

          # è·å–ä¸‹ä¸ªæœˆçš„ç¬¬ä¸€å¤©ï¼Œç„¶åå‡ä¸€å¤©ï¼Œå¾—åˆ°å½“æœˆæœ€åä¸€å¤©
          next_month=$(date -d "$(date +%Y-%m-01) +1 month" +%Y-%m-01)
          last_day=$(date -d "$next_month -1 day" +%d)

          echo "current_day=$current_day"
          echo "last_day=$last_day"

          # åˆ¤æ–­æ˜¯å¦æ˜¯æœ€åä¸€å¤©
          if [ "$current_day" == "$last_day" ]; then
            echo "is_last_day=true" >> $GITHUB_OUTPUT
          else
            echo "is_last_day=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate Monthly Report (Imaging)
        if: steps.check_date.outputs.is_last_day == 'true' || github.event_name == 'workflow_dispatch'
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          SHEET_ID_2: ${{ secrets.SHEET_ID_2 }}  # åŒ»å­¦å½±åƒæŠ¥å‘Šçš„ Sheet ID
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_API_URL: ${{ secrets.GEMINI_API_URL }}
        run: |
          if [ -n "${{ github.event.inputs.year }}" ] && [ -n "${{ github.event.inputs.month }}" ]; then
            python scripts/generate_report.py --config-name imaging --mode monthly --year "${{ github.event.inputs.year }}" --month "${{ github.event.inputs.month }}"
          else
            python scripts/generate_report.py --config-name imaging --mode monthly
          fi

      - name: Commit and Push
        if: steps.check_date.outputs.is_last_day == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add reports/
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "ğŸ“Š Imaging monthly report $(date +%Y-%m)"
            git push
            echo "æŠ¥å‘Šå·²æäº¤å¹¶æ¨é€"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
