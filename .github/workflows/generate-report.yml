name: Generate Daily Report

on:
  # æ¯å¤© 23:00 (åŒ—äº¬æ—¶é—´) = 15:00 UTC è¿è¡Œ
  schedule:
    - cron: '0 15 * * *'
  
  # æ¯æœˆæœ€åŽä¸€å¤©é¢å¤–è¿è¡ŒæœˆæŠ¥ï¼ˆåœ¨ 23:30 UTC = 07:30 åŒ—äº¬æ—¶é—´ç¬¬äºŒå¤©ï¼‰
  # æ³¨æ„ï¼šå¯¹äºŽä¸åŒæœˆä»½çš„æœ€åŽä¸€å¤©ï¼Œéœ€è¦åˆ†åˆ«é…ç½®
  # è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œåœ¨æ¯æœˆ28-31å·éƒ½å°è¯•ç”ŸæˆæœˆæŠ¥
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      mode:
        description: 'ç”Ÿæˆæ¨¡å¼ (daily/monthly)'
        required: true
        default: 'daily'
        type: choice
        options:
          - daily
          - monthly
      date:
        description: 'æŒ‡å®šæ—¥æœŸ (YYYY-MM-DDï¼Œä»…ç”¨äºŽ daily æ¨¡å¼)'
        required: false
      year:
        description: 'æŒ‡å®šå¹´ä»½ï¼ˆä»…ç”¨äºŽ monthly æ¨¡å¼ï¼‰'
        required: false
      month:
        description: 'æŒ‡å®šæœˆä»½ï¼ˆä»…ç”¨äºŽ monthly æ¨¡å¼ï¼‰'
        required: false

jobs:
  generate-daily-report:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'daily')
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Generate Daily Report
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
        run: |
          cd scripts
          if [ -n "${{ github.event.inputs.date }}" ]; then
            python generate_report.py --mode daily --date "${{ github.event.inputs.date }}"
          else
            python generate_report.py --mode daily
          fi
      
      - name: Commit and Push
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add reports/
          git diff --staged --quiet || git commit -m "ðŸ“ Daily report $(date +%Y-%m-%d)"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  generate-monthly-report:
    runs-on: ubuntu-latest
    # æ¯æœˆ28-31å·è¿è¡Œï¼Œæˆ–æ‰‹åŠ¨è§¦å‘ monthly æ¨¡å¼
    if: |
      (github.event_name == 'schedule' && 
       (github.event.schedule == '0 15 28 * *' || 
        github.event.schedule == '0 15 29 * *' || 
        github.event.schedule == '0 15 30 * *' || 
        github.event.schedule == '0 15 31 * *')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'monthly')
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Check if Last Day of Month
        id: check_date
        run: |
          # èŽ·å–å½“å‰æ—¥æœŸ
          current_day=$(date +%d)
          current_month=$(date +%m)
          current_year=$(date +%Y)
          
          # èŽ·å–ä¸‹ä¸ªæœˆçš„ç¬¬ä¸€å¤©ï¼Œç„¶åŽå‡ä¸€å¤©ï¼Œå¾—åˆ°å½“æœˆæœ€åŽä¸€å¤©
          next_month=$(date -d "$(date +%Y-%m-01) +1 month" +%Y-%m-01)
          last_day=$(date -d "$next_month -1 day" +%d)
          
          echo "current_day=$current_day"
          echo "last_day=$last_day"
          
          # åˆ¤æ–­æ˜¯å¦æ˜¯æœ€åŽä¸€å¤©
          if [ "$current_day" == "$last_day" ]; then
            echo "is_last_day=true" >> $GITHUB_OUTPUT
          else
            echo "is_last_day=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate Monthly Report
        if: steps.check_date.outputs.is_last_day == 'true' || github.event_name == 'workflow_dispatch'
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
        run: |
          cd scripts
          if [ -n "${{ github.event.inputs.year }}" ] && [ -n "${{ github.event.inputs.month }}" ]; then
            python generate_report.py --mode monthly --year "${{ github.event.inputs.year }}" --month "${{ github.event.inputs.month }}"
          else
            python generate_report.py --mode monthly
          fi
      
      - name: Commit and Push
        if: steps.check_date.outputs.is_last_day == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add reports/
          git diff --staged --quiet || git commit -m "ðŸ“Š Monthly report $(date +%Y-%m)"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
